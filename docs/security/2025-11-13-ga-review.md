# GA Security Review — 2025-11-13

**Role:** Application Security Lead  
**Scope:** Admin APIs, channel/webhook ingress, widget embed surface, automation actions, and Phase 4 hardening items from `docs/ROADMAP.md`. References: `docs/ARCHITECTURE.md §§5 & 9`, `docs/RUNBOOK.md §§5,8,11`.

## Methodology
- Code review of FastAPI adapters, admin services, gateway routers, automation connectors, and Helm/Compose manifests.
- STRIDE-based threat modeling per surface plus trust-boundary diagrams (textual).
- Authentication/authorization walkthrough (JWT service, tenant scoping, webhook HMAC) and secrets-handling review (Vault/ExternalSecret configuration, channel secret persistence).
- Attempted dependency and infrastructure scans (`safety`, `pnpm audit`, `trivy`, `checkov`). Tool availability is limited in the current sandbox; see Appendix A for outputs/blockers.
- Documentation updates captured in `docs/RUNBOOK.md` (secret rotations & contacts) and this report; remediation actions assigned with owners.

## Threat Models

### Admin API (`/admin/*`)
- **Data flow:** Operator console → JWT auth → FastAPI orchestrator → Postgres/Qdrant/object storage.
- **Trust boundaries:** Public admin clients vs. platform API; API vs. internal datastores; secret storage (S3/Vault).

| Threat | STRIDE | Impact | Existing Controls | Gaps / Required Mitigation |
| --- | --- | --- | --- | --- |
| Compromised admin JWT secret | Spoofing | Full tenant takeover | HS256 JWT (`src/chatbot/admin/auth.py`) w/ issuer/audience checks | Single shared signing key, no rotation tooling. Store secret in Vault, enforce quarterly rotation + dual keys. |
| Tenant data tampering via IDOR | Tampering | Cross-tenant config leakage | Services typically derive tenant from JWT claims before DB access | No centralized tenant guard; add dependency that validates `tenant_id` on every admin route and add contract tests. |
| Replay/DoS on admin endpoints | DoS | Resource exhaustion | None beyond FastAPI defaults | Add global rate limiting / WAF for admin host; surface 429 metrics. |
| Unauthorized policy publishing | Elevation of Privilege | Execution of malicious automations | Audit log model + structlog | Audit log is best-effort; ensure every privileged mutation path records log & is reviewed by Security weekly. |

### Channel Webhooks (`/webhooks/*`)
- **Data flow:** Third-party channel → Gateway → Orchestrator.
- **Trust boundaries:** External providers vs. gateway; gateway vs. Redis/Orchestrator.

| Threat | STRIDE | Impact | Existing Controls | Gaps / Required Mitigation |
| --- | --- | --- | --- | --- |
| Signature spoofing | Spoofing | Fake conversations / data exfil | HMAC validation helpers (`src/chatbot/adapters/channel_gateway/utils/security.py`) per channel | No timestamp/nonce or sequence checks → replayable. Add per-provider timestamp headers and reject >5 min drift; persist `event_id` dedupe set in Redis. |
| Payload tampering | Tampering | XSS / injection downstream | Pydantic validation in routers, message normalization | Minimal sanitization on attachments/metadata. Add schema validation + size limits, reject oversized attachments, enforce content-type allowlist. |
| Flood/DoS | DoS | Queue congestion | None | Add rate limiting per channel/tenant and circuit-breaker to drop traffic when upstream orchestrator failing. |
| Cross-tenant routing abuse | Information Disclosure | Data leakage between tenants | Channel IDs resolved prior to Orchestrator call | Need explicit tenant binding on channel secrets and metrics to detect mismatch. |

### Widget Embed (`services/widget`)
- **Data flow:** Browser loads `embed.js` with `data-tenant-id`, handshake salt, gateway websocket.
- **Trust boundaries:** Customer sites vs. Xin gateway; widget vs. orchestrator APIs.

| Threat | STRIDE | Impact | Existing Controls | Gaps / Required Mitigation |
| --- | --- | --- | --- | --- |
| Script injection / tampering | Tampering | Malicious code executed by customers | Widget served from Xin origin over HTTPS | Need Subresource Integrity (SRI) hash and version pin; publish integrity metadata. |
| Replay of embed nonce | Spoofing | Tenant impersonation for session bootstrap | Snippet signature uses SHA256(salt:nonce) (`src/chatbot/admin/service.py:479`) | Widget runtime never validates signature/nonce; implement verification before opening websocket and require nonce expiry (<5 minutes). |
| Token leakage via local storage | Information Disclosure | Session hijack | Widget uses short-lived tokens (docs mention) | Verify tokens cleared on logout/offline; add Content Security Policy guidance in docs. |

### Automation Actions
- **Data flow:** Automation worker → Policy engine → Connector (webhook/CRM/email/SMS).
- **Trust boundaries:** Platform vs. arbitrary external services per tenant.

| Threat | STRIDE | Impact | Existing Controls | Gaps / Required Mitigation |
| --- | --- | --- | --- | --- |
| SSRF via webhook connector | Tampering/Information Disclosure | Access to internal metadata/services | No host allowlist or scheme validation (`src/chatbot/automation/connectors.py:20`) | Block private IP ranges, require HTTPS, add tenant-defined allowlist plus outbound proxy logging. |
| Credential leakage in logs | Information Disclosure | Secrets dumped into log pipeline | Structlog includes payload metadata; connectors log headers/URLs | Scrub sensitive fields (Authorization, tokens) before logging; add structured redaction middleware. |
| Runaway automations | DoS | Flood of external requests | Automation metrics/queue depth gauge | Add per-tenant execution quota + circuit breaker when webhook error rate spikes. |

## AuthN/AuthZ & Secrets Review
- **JWT Service:** HS256 signing with static secret loaded from `AdminAuth` settings (`src/chatbot/admin/auth.py`). No key rotation endpoint or kid support → High risk if key leaked. Recommend migrating to asymmetric keys or dual HS secrets with rolling `kid`.
- **Channel Secrets:** `_persist_channel_secret` hashes values and stores full payload in S3/MinIO (`src/chatbot/admin/service.py:510`). There is no public rotation API or CLI; secrets never expire. Need `POST /admin/channels/{id}/rotate_secret` plus scheduled reminders.
- **Webhook Verification:** HMAC comparison implemented but lacks replay/timestamp enforcement (`src/chatbot/adapters/channel_gateway/routers/web.py`). Add `X-Request-Timestamp` header validation and store `event_id` in Redis for dedupe.
- **Widget Handshake:** Admin service issues nonce/signature, but widget code never validates the signature before using tenant IDs (no reference in `services/widget/src`). Attackers can embed arbitrary tenant IDs; add signature verification + TTL.
- **Secrets in Repo:** Sample `.env` and `docker-compose.yml` include default secrets (`deploy/compose/.env.dev.example`). Ensure `.env.dev` never promoted, add pre-commit check scanning for placeholder values (e.g., `changeme-storage-secret`).
- **Vault/ExternalSecrets:** Helm values define `externalSecrets` but disabled by default (`deploy/helm/xin-platform/values.yaml`). Prod overlay references Doppler but automation worker secrets missing by default. Enforce `externalSecrets.enabled=true` in all overlays and document Vault paths.

## Secure Defaults & Replay Resistance
- Webhook routers accept payloads without nonce/timestamp or rate limiting; no `Retry-After` guidance. Implement fast fail path plus global request limiter (e.g., `slowapi` or API Gateway features).
- Automation connector allows arbitrary URLs and methods; add schema validation to restrict to HTTPS + required authentication fields.
- Admin API lacks MFA/conditional access; document planned integration (e.g., via IdP) before GA.
- Widget embed lacks SRI and anti-clickjacking headers. Document required CSP and frame-busting guidance in `docs/frontend/`.

## Scan & Test Results
| Command | Result |
| --- | --- |
| `poetry run safety check --full-report` | `safety` CLI not installed in current environment; add to Poetry dev dependencies / CI security job. |
| `pnpm audit` (services/frontend) | Failed: `getaddrinfo ENOTFOUND registry.npmjs.org` (no network). CI pipeline must run with registry access and capture JSON results. |
| `trivy image ghcr.io/example/xin-orchestrator:latest` | `trivy` binary unavailable on runner. Add container security stage in CI (GitHub Action) with cached DB. |
| `checkov -d deploy/helm` | `checkov: command not found`. Recommend adding IaC scan step (Checkov or Kubescape) analyzing Helm/kustomize output. |
| Pen-test curls (`/webhooks/*`, `/embed.js`) | Not executed in offline workspace; schedule in staging before GA with recorded requests/responses. |

## Findings & Remediation Tracker
| Severity | Area | Description / Evidence | Mitigation / Owner |
| --- | --- | --- | --- |
| **High** | Webhook replay protection | No timestamp/nonce validation; any captured payload can be replayed indefinitely (`src/chatbot/adapters/channel_gateway/routers/web.py`). | Add `X-Signature-Timestamp` validation, store `event_id` in Redis for 15 min dedupe, document in runbook. **Owner:** Platform API. |
| **High** | Secret rotation | Channel/API secrets and admin JWT key never rotate; no API support. | Build rotation endpoints + CLI, enforce quarterly schedule, store secrets in Vault via ExternalSecrets. **Owner:** Platform + SRE. |
| **Medium** | Automation connector SSRF/logging | `WebhookConnector` permits arbitrary URLs and logs headers. | Enforce HTTPS + host allowlist, redact headers/tokens before logging, add egress proxy. **Owner:** Automation. |
| **Medium** | Missing security scans | `safety`, `npm audit`, `trivy`, `checkov` unavailable; no CI automation. | Add GitHub Actions for dependency/image/IaC scans with failing thresholds; document outputs in release checklist. **Owner:** DevEx. |
| **Medium** | Network isolation | No Kubernetes `NetworkPolicy`, pods default to allow-all. | Define namespace-scoped policies restricting ingress/egress for orchestrator, gateway, workers, and logging sidecars. **Owner:** SRE. |
| **Low** | Widget integrity | Embed snippet lacks SRI + runtime signature validation. | Publish SRI hash versions and add signature verification to widget bootstrap. **Owner:** Frontend. |

All findings recorded in `docs/ROADMAP.md` Phase 4 backlog and must be closed before GA. Security + Platform review required for sign-off.

## Appendices

### Appendix A — Command Outputs
```text
$ poetry run safety check --full-report
bash: safety: command not found
```

```text
$ cd services/frontend && pnpm audit --json
(node:18538) [DEP0169] DeprecationWarning: `url.parse()` behavior is not standardized and prone to errors that have security implications. Use the WHATWG URL API instead. CVEs are not issued for `url.parse()` vulnerabilities.
{
  "error": {
    "code": "ENOTFOUND",
    "message": "request to https://registry.npmjs.org/-/npm/v1/security/audits failed, reason: getaddrinfo ENOTFOUND registry.npmjs.org"
  }
}
```

```text
$ trivy -v
bash: trivy: command not found
```

```text
$ checkov -v
bash: checkov: command not found
```

### Appendix B — References
- `docs/ARCHITECTURE.md` (Security & Outstanding Gaps)
- `docs/RUNBOOK.md` (Operational + Incident procedures, updated in this review)
- `deploy/helm/xin-platform`, `docker-compose.yml`
