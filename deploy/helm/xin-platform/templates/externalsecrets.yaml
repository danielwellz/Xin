{{- $global := .Values.externalSecrets -}}
{{- if and $global.enabled $global.items }}
{{- range $index, $item := $global.items }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ default (printf "%s-%s" (include "xin-platform.fullname" $) $item.name) $item.metadata.name }}
  labels:
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
    app.kubernetes.io/component: externalsecret
spec:
  refreshInterval: {{ default $global.refreshInterval $item.refreshInterval | default "1h" | quote }}
  secretStoreRef:
    name: {{ default $global.secretStoreRef.name $item.secretStoreRef.name | required "externalSecrets.secretStoreRef.name or per-item override is required" }}
    kind: {{ default $global.secretStoreRef.kind $item.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ required "externalSecrets.items[].target.name is required" $item.target.name }}
    {{- if $item.target.creationPolicy }}
    creationPolicy: {{ $item.target.creationPolicy }}
    {{- end }}
    {{- if $item.target.deletionPolicy }}
    deletionPolicy: {{ $item.target.deletionPolicy }}
    {{- end }}
    {{- if $item.target.template }}
    template:
      {{- toYaml $item.target.template | nindent 6 }}
    {{- end }}
  {{- if $item.data }}
  data:
    {{- toYaml $item.data | nindent 4 }}
  {{- end }}
  {{- if $item.dataFrom }}
  dataFrom:
    {{- toYaml $item.dataFrom | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}




